# Reusable workflow for Claude AI interaction on issues/PRs/comments
name: Claude Code

on:
  workflow_call:
    inputs:
      allowed-tools:
        description: 'Allowed tools for Claude Code (comma-separated)'
        required: false
        type: string
        # This workflow uses mcp__github__* wildcard to grant broad GitHub API access
        # because this agent is designed to make changes (read-write operations):
        # creating/updating issues, PRs, branches, pushing commits, etc.
        # For read-only review workflows, see claude-code-review.yml which restricts
        # to specific MCP tools needed only for commenting.
        default: 'Bash(gh:*),Bash(go:*),Bash(make:*),Bash(git:*),Bash(npm:*),Bash(cargo:*),mcp__codesign__sign_file,mcp__github__*,WebFetch,WebSearch'
      additional-permissions:
        description: 'Additional GitHub API permissions for Claude'
        required: false
        type: string
        default: 'actions: read'
    secrets:
      CLAUDE_APP_ID:
        description: 'Claude GitHub App ID'
        required: false
      CLAUDE_APP_PRIVATE_KEY:
        description: 'Claude GitHub App private key'
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'Claude Code OAuth token'
        required: true

jobs:
  claude:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Authenticate GitHub CLI
        run: echo "${{ steps.app-token.outputs.token }}" | gh auth login --with-token

      - name: Setup Claude Stop Hook
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
        run: |
          mkdir -p ~/.config/claude-code
          cat > ~/.config/claude-code/settings.json <<'EOF'
          {
            "hooks": {
              "Stop": [
                {
                  "type": "command",
                  "command": "bash -c '\n            # Exit early if no PR context\n            if [ -z \"$PR_NUMBER\" ]; then\n              echo \"✅ No PR context, allowing exit\"\n              exit 0\n            fi\n            \n            # Fetch PR check data\n            CHECK_DATA=$(gh pr checks \"$PR_NUMBER\" --repo \"$GITHUB_REPOSITORY\" \\\n              --json name,state,conclusion,detailsUrl 2>/dev/null)\n            \n            # Exit if no checks found or command failed\n            if [ $? -ne 0 ] || [ \"$CHECK_DATA\" = \"[]\" ]; then\n              echo \"✅ No checks found for PR #$PR_NUMBER, allowing exit\"\n              exit 0\n            fi\n            \n            # Count pending and failed checks\n            PENDING=$(echo \"$CHECK_DATA\" | jq -r \"[.[] | select(.state != \\\"COMPLETED\\\")] | length\")\n            FAILED=$(echo \"$CHECK_DATA\" | jq -r \"[.[] | select(.state == \\\"COMPLETED\\\" and .conclusion != \\\"SUCCESS\\\" and .conclusion != \\\"NEUTRAL\\\" and .conclusion != \\\"SKIPPED\\\")] | length\")\n            FAILED_CHECKS=$(echo \"$CHECK_DATA\" | jq -r \"[.[] | select(.state == \\\"COMPLETED\\\" and .conclusion != \\\"SUCCESS\\\" and .conclusion != \\\"NEUTRAL\\\" and .conclusion != \\\"SKIPPED\\\")] | map(\\\"  - \\\" + .name + \\\" (\\\" + .conclusion + \\\"): \\\" + .detailsUrl) | join(\\\"\\\\n\\\")\")\n            \n            # Exit based on check status\n            if [ \"$PENDING\" -gt 0 ]; then\n              echo \"⏳ $PENDING check(s) still running on PR #$PR_NUMBER\" >&2\n              exit 2\n            elif [ \"$FAILED\" -gt 0 ]; then\n              echo \"❌ $FAILED check(s) failed on PR #$PR_NUMBER:\" >&2\n              echo \"\" >&2\n              echo \"$FAILED_CHECKS\" >&2\n              echo \"\" >&2\n              echo \"Please investigate the failures and fix any issues before exiting.\" >&2\n              exit 1\n            else\n              echo \"✅ All PR checks passed\"\n              exit 0\n            fi\n          '"
                }
              ]
            }
          }
          EOF

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          additional_permissions: ${{ inputs.additional-permissions }}
          claude_args: --allowedTools "${{ inputs.allowed-tools }}"
          allowed_bots: 'claude-code-for-richardmsong[bot]'
          append_system_prompt: |

            ---

            **IMPORTANT - Prefer GitHub MCP Server Tools Over gh CLI:**

            When interacting with GitHub (issues, PRs, comments, reviews), you MUST prefer using the GitHub MCP server tools instead of gh CLI commands. The MCP tools provide better structure, error handling, and are the recommended approach.

            **Available GitHub MCP Tools:**
            - `mcp__github__create_issue` - Create new issues
            - `mcp__github__update_issue` - Update issue title, body, state
            - `mcp__github__add_issue_comment` - Add comments to issues
            - `mcp__github__create_pull_request` - Create PRs
            - `mcp__github__update_pull_request` - Update PR details
            - `mcp__github__add_pull_request_comment` - Add comments to PRs
            - `mcp__github__create_pending_pull_request_review` - Start a PR review
            - `mcp__github__add_comment_to_pending_review` - Add inline comments to pending review
            - `mcp__github__submit_pending_pull_request_review` - Submit the review
            - `mcp__github__get_pull_request_diff` - Get PR diff with line numbers
            - `mcp__github__list_issues` - List repository issues
            - `mcp__github__list_pull_requests` - List repository PRs
            - `mcp__github__get_issue` - Get issue details
            - `mcp__github__get_pull_request` - Get PR details
            - `mcp__github__search_code` - Search code in the repository
            - `mcp__github__search_issues` - Search issues and PRs
            - And more...

            **When to Use MCP vs gh CLI:**
            - ✅ **Use MCP**: For creating/updating issues, PRs, comments, reviews, and searching
            - ⚠️ **Use gh CLI**: Only when MCP tools don't provide the needed functionality (e.g., checking PR checks status, managing workflows)

            **Example - Creating PR Comments:**
            - ❌ BAD: `gh pr comment $PR_NUMBER --body "comment"`
            - ✅ GOOD: `mcp__github__add_pull_request_comment` with appropriate parameters

            **Example - Creating PR Reviews:**
            Instead of using `gh pr comment`, use the structured review flow:
            1. `mcp__github__create_pending_pull_request_review` - Start review
            2. `mcp__github__get_pull_request_diff` - Get diff to understand line numbers
            3. `mcp__github__add_comment_to_pending_review` - Add inline comments (repeat as needed)
            4. `mcp__github__submit_pending_pull_request_review` - Submit with event type "COMMENT"

            **Document Your MCP Usage:**
            When you use MCP tools in PRs or comments, clearly document what you're doing:
            - Before calling an MCP tool, explain what it will do
            - After completion, summarize the action taken
            - This helps users understand the MCP-based workflow

            ---

            **Workflow Control**: If you prefer manual control, you can [⏹️ Cancel Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
