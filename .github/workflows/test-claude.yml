name: Test Claude Integration

on:
  pull_request:
    paths:
      - '.github/workflows/claude.yml'

jobs:
  test-claude:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Test Claude - Verify tools and permissions
        id: claude-test
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools "Bash(go:*),Bash(make:*),Bash(git:*),Bash(npm:*),Bash(cargo:*),mcp__codesign__sign_file"
          direct_prompt: |
            This is an automated test to verify Claude's integration is working correctly.

            Please perform these tests and report the results:

            1. **Tool Access Test**: Run `git status` to verify you can use git tools
            2. **Comment Test**: Post a comment on this PR confirming the test passed
            3. **Push Test**: Create a test file at `test-output/.claude-test-$(date +%s).txt` with the current timestamp, commit it to a new branch `test/claude-verify-${{ github.run_id }}`, and push it

            After completing all tests, summarize what worked and what failed.
            If any test fails, clearly indicate which one and why.

      - name: Verify test branch was created
        run: |
          git fetch origin
          if git branch -r | grep -q "test/claude-verify-${{ github.run_id }}"; then
            echo "✅ Push test passed - branch was created"
          else
            echo "❌ Push test failed - branch was not created"
            exit 1
          fi

      - name: Cleanup test branch
        if: always()
        continue-on-error: true
        run: |
          git push origin --delete "test/claude-verify-${{ github.run_id }}" || true
