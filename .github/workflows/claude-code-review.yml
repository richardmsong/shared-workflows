# Reusable workflow for automated code review via Claude
name: Claude Code Review

on:
  workflow_call:
    inputs:
      review-prompt:
        description: 'Custom review prompt (optional)'
        required: false
        type: string
        default: ''
      allowed-tools:
        description: 'Allowed tools for Claude Code review'
        required: false
        type: string
        # This workflow explicitly lists specific MCP tools to restrict access
        # because this agent is designed for read-only code review operations:
        # reading diffs, creating review comments, searching code/issues.
        # It should NOT make changes to code, branches, or repository state.
        # For read-write operations, see claude.yml which grants broader access.
        default: >-
          mcp__github__create_pending_pull_request_review,
          mcp__github__add_comment_to_pending_review,
          mcp__github__submit_pending_pull_request_review,
          mcp__github__get_pull_request_diff,
          mcp__github__get_pull_request_files,
          mcp__github__get_pull_request_review_comments,
          mcp__github__get_pull_request,
          mcp__github__list_pull_requests,
          mcp__github__search_code,
          mcp__github__search_issues,
          Bash(gh pr checks:*),
          Bash(gh pr view:*),
          Bash(gh:*)
    secrets:
      CLAUDE_APP_ID:
        description: 'Claude GitHub App ID'
        required: false
      CLAUDE_APP_PRIVATE_KEY:
        description: 'Claude GitHub App private key'
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'Claude Code OAuth token'
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ steps.app-token.outputs.token }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            CRITICAL - Use GitHub MCP Tools for Inline Code Reviews:
            You MUST use the GitHub MCP server to provide inline code review comments. Follow these steps:

            1. **Get PR diff**: Use `mcp__github__get_pull_request_diff` to understand the code changes and line numbers
               - This shows you what lines were added/modified in each file
               - Note the line numbers for comments

            2. **Start a pending review**: Use `mcp__github__create_pending_pull_request_review` to begin your review
               - Set the event type to "COMMENT" (not "REQUEST_CHANGES") to avoid blocking the PR
               - Save the review_id from the response

            3. **Add inline comments**: Use `mcp__github__add_comment_to_pending_review` for each specific piece of feedback
               - Include: review_id (from step 2), file path, line number (or start_line/end_line for multi-line), comment body
               - Make comments specific, actionable, and constructive
               - Focus on: bugs, security issues, performance problems, best practices violations
               - **Document your MCP usage**: Before each call, explain what you're doing (e.g., "Adding inline comment about error handling at line 45")

            4. **Submit the review**: Use `mcp__github__submit_pending_pull_request_review` with:
               - event: "COMMENT" (this prevents blocking the PR merge)
               - body: A summary of your review findings
               - **Document completion**: After submitting, confirm the review was posted

            **Review Focus Areas:**
            ${{ inputs.review-prompt || '- Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage' }}

            **Best Practices:**
            - Be constructive and helpful in feedback
            - Reference specific line numbers in your comments
            - Provide actionable suggestions with examples when possible. 
            - Do not create any comments that do not have actionable suggestions. 
            - Do not create any comments that only contain praise or affirmation.
            - Use the repository's CLAUDE.md for style and convention guidance
            - Keep inline comments focused and concise
            - Use the overall review body for high-level observations

            **Version Verification:**
            Before claiming a software version doesn't exist or hasn't been released:
            1. Search the web for the latest version
            2. Check official sources (GitHub releases, package registries, official docs)
            3. Cite your sources when making version-related claims
            4. If you cannot verify a version exists, say "I was unable to verify this version" rather than asserting it doesn't exist

            **IMPORTANT - DO NOT use gh CLI for reviews:**
            - ❌ DO NOT use `gh pr comment` or `gh api` for creating review comments
            - ✅ ALWAYS use the MCP tools listed above for structured inline reviews
            - MCP tools provide better integration and proper inline comment placement

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "${{ inputs.allowed-tools }}"'
