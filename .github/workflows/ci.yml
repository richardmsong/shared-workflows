# Reusable CI workflow for Go/kubebuilder projects
# Provides test, lint, build, and Docker image publishing stages
name: CI

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      go-version:
        description: 'Go version to use (ignored if go-version-file is set)'
        required: false
        type: string
        default: '1.22'
      go-version-file:
        description: 'Path to go.mod file for Go version detection'
        required: false
        type: string
        default: 'go.mod'
      registry:
        description: 'Container registry URL'
        required: false
        type: string
        default: 'ghcr.io'
      image-name:
        description: 'Docker image name (defaults to repository name)'
        required: false
        type: string
        default: ''
      push-image:
        description: 'Whether to push the Docker image'
        required: false
        type: boolean
        default: true
      run-tests:
        description: 'Whether to run tests'
        required: false
        type: boolean
        default: true
      run-lint:
        description: 'Whether to run linting'
        required: false
        type: boolean
        default: true
      lint-version:
        description: 'golangci-lint version'
        required: false
        type: string
        default: 'v2.7.2'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      docker-build-target:
        description: 'Docker build target (Makefile target name)'
        required: false
        type: string
        default: 'docker-buildx-ci'
    outputs:
      image-tags:
        description: 'Docker image tags'
        value: ${{ jobs.docker.outputs.tags }}
    secrets:
      CLAUDE_APP_ID:
        description: 'GitHub App ID for authentication'
        required: true
      CLAUDE_APP_PRIVATE_KEY:
        description: 'GitHub App private key for authentication'
        required: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ inputs.run-tests }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ inputs.working-directory }}/${{ inputs.go-version-file }}
          cache: true

      - name: Run tests
        run: make test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ inputs.working-directory }}/cover.out
          retention-days: 7

  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: ${{ inputs.run-lint }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ inputs.working-directory }}/${{ inputs.go-version-file }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: ${{ inputs.lint-version }}
          working-directory: ${{ inputs.working-directory }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ inputs.working-directory }}/${{ inputs.go-version-file }}
          cache: true

      - name: Build
        run: make build

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    outputs:
      tags: ${{ steps.tags.outputs.tags }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    env:
      REGISTRY: ${{ inputs.registry }}
      IMAGE_NAME: ${{ inputs.image-name || github.repository }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ inputs.working-directory }}/${{ inputs.go-version-file }}
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker tags
        id: tags
        run: |
          TAGS=""
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          # Always add SHA tag for ephemeral builds
          TAGS="sha-${SHA_SHORT}"

          # Add branch name for pushes
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/* ]]; then
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            TAGS="${TAGS} ${BRANCH_NAME}"
          fi

          # Add PR number for pull requests
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAGS="${TAGS} pr-${{ github.event.pull_request.number }}"
          fi

          # Add semver tags for version tags
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            TAGS="${TAGS} ${VERSION} ${MAJOR}.${MINOR} latest"
            # Only add major tag if not v0.x.x
            if [[ "$MAJOR" != "0" ]]; then
              TAGS="${TAGS} ${MAJOR}"
            fi
          fi

          # Add latest for default branch
          if [[ "${{ github.ref }}" == "refs/heads/${{ github.event.repository.default_branch }}" ]]; then
            TAGS="${TAGS} latest"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ steps.app-token.outputs.token }}

      - name: Build and push Docker image
        run: make ${{ inputs.docker-build-target }}
        env:
          DOCKER_TAGS: ${{ steps.tags.outputs.tags }}
          DOCKER_PUSH: ${{ inputs.push-image && '1' || '' }}
