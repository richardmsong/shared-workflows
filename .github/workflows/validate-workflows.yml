name: Validate Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow inputs
        run: |
          #!/bin/bash
          set -e

          errors=0

          for workflow in .github/workflows/*.yml; do
            echo "Checking $workflow..."

            # Check if workflow uses inputs.* references
            if grep -q '\${{ *inputs\.' "$workflow"; then
              # Check if workflow has non-workflow_call triggers
              has_other_triggers=false

              # Look for direct triggers (issues, pull_request, issue_comment, push, etc.)
              if grep -E '^\s+(issues|pull_request|issue_comment|push|schedule|workflow_dispatch):' "$workflow" | grep -v '#' > /dev/null; then
                has_other_triggers=true
              fi

              if [ "$has_other_triggers" = true ]; then
                echo "::error file=$workflow::Workflow uses \${{ inputs.* }} but has triggers other than workflow_call. Inputs are only available for workflow_call triggers."
                errors=$((errors + 1))
              fi
            fi
          done

          if [ $errors -gt 0 ]; then
            echo ""
            echo "Found $errors workflow(s) with input reference issues."
            echo "If a workflow has direct triggers (issues, pull_request, etc.), inputs.* will be empty."
            echo "Either remove the direct triggers or hardcode the values."
            exit 1
          fi

          echo "All workflows validated successfully."
